<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Archivio Tribuna Critica – Notariqon</title>
    <style>
        body {
            font-family: 'Helvetica', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8f0e0;
            color: #222;
            line-height: 1.8;
        }
        
        header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 30px;
            margin-bottom: 30px;
            background: #fffff5;
            padding: 40px 20px 30px;
            border-radius: 8px;
        }
        
        h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            color: #5a3f11;
        }
        
        .subtitle {
            font-size: 1.1em;
            color: #555;
            font-style: italic;
        }
        
        .count {
            text-align: center;
            font-size: 0.9em;
            color: #888;
            margin-bottom: 30px;
            background: #fffff5;
            padding: 15px;
            border-radius: 4px;
        }
        
        /* Select autori mobile */
        #authors-mobile {
            display: none;
            margin-bottom: 25px;
        }
        
        #authors-mobile label {
            display: block;
            font-size: 0.95em;
            color: #5a3f11;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        #authors-mobile select {
            width: 100%;
            padding: 12px 15px;
            font-size: 1em;
            font-family: 'Helvetica', sans-serif;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fffff5;
            color: #333;
            cursor: pointer;
        }
        
        #authors-mobile select:focus {
            outline: none;
            border-color: #5a3f11;
        }
        
        /* Sidebar Autori in Tribuna */
        #authors-cloud {
            position: fixed;
            top: 120px;
            right: 20px;
            width: 180px;
            padding: 15px;
            background: #fffff5;
            border: 1px solid #e0dcc0;
            border-radius: 4px;
            font-size: 0.85em;
            line-height: 1.9;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        #authors-cloud h4 {
            font-size: 0.95em;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
            color: #5a3f11;
        }
        
        #authors-cloud .cloud-content {
            text-align: left;
        }
        
        #authors-cloud .cloud-content a {
            display: block;
            margin-bottom: 8px;
            color: #444;
            text-decoration: none;
            cursor: pointer;
        }
        
        #authors-cloud .cloud-content a:hover {
            text-decoration: underline;
            color: #5a3f11;
        }
        
        /* Griglia schede */
        .archive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .scheda-card {
            background: #fffff5;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0dcc0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .scheda-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .post-date {
            font-size: 0.85em;
            color: #888;
            font-style: italic;
            margin-bottom: 8px;
        }
        
        .post-author {
            font-weight: bold;
            color: #333;
            margin: 5px 0;
            font-size: 1.1em;
        }
        
        .post-title {
            font-style: italic;
            color: #555;
            margin: 8px 0 12px 0;
        }
        
        .post-link {
            color: #5a3f11;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .post-link:hover {
            text-decoration: underline;
        }
        
        footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        
        footer a {
            color: #555;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 1100px) {
            #authors-cloud { 
                display: none; 
            }
            
            #authors-mobile {
                display: block;
            }
            
            .archive-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        @media (max-width: 600px) {
            .archive-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar autori Tribuna -->
    <div id="authors-cloud">
        <h4>Autori in Tribuna</h4>
        <div class="cloud-content" id="cloud-content">
            Caricamento...
        </div>
    </div>

    <header>
        <h1>Archivio Tribuna Critica</h1>
        <p class="subtitle">Tutte le schede di analisi poetica</p>
    </header>

    <div class="count" id="total-count">Caricamento...</div>

    <!-- Select autori per mobile -->
    <div id="authors-mobile">
        <label for="author-select">Autori in Tribuna</label>
        <select id="author-select">
            <option value="">Tutti gli autori</option>
        </select>
    </div>

    <div class="archive-grid" id="archive-content">
        <div class="scheda-card">Caricamento archivio...</div>
    </div>

    <footer>
        <a href="../index.html">← Torna a Notariqon</a>
    </footer>

    <script>
        // Funzione per convertire data italiana in slug
        function makeSlug(dateStr) {
            return dateStr.toLowerCase().replace(/ /g, '-');
        }

        // Funzione per parsare data italiana
        function parseItalianDate(dateStr) {
            const mesi = {
                'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
                'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
                'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
            };
            const parts = dateStr.toLowerCase().split(' ');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = mesi[parts[1]];
                const year = parseInt(parts[2]);
                if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }
            return new Date(0);
        }

        // Genera cloud autori
        function generateAuthorsCloud(posts) {
            const cloudContainer = document.getElementById('cloud-content');
            if (!cloudContainer || posts.length === 0) {
                if (cloudContainer) cloudContainer.innerHTML = '<em style="color:#999;">Nessun autore</em>';
                return;
            }

            // Conta occorrenze per autore
            const authorCounts = {};
            posts.forEach(post => {
                if (post.author) {
                    authorCounts[post.author] = (authorCounts[post.author] || 0) + 1;
                }
            });

            const authors = Object.keys(authorCounts);
            if (authors.length === 0) {
                cloudContainer.innerHTML = '<em style="color:#999;">Nessun autore</em>';
                return;
            }

            // Calcola min e max per scalare font-size
            const counts = Object.values(authorCounts);
            const minCount = Math.min(...counts);
            const maxCount = Math.max(...counts);
            
            const minFont = 0.8;
            const maxFont = 1.5;

            // Ordina alfabeticamente per cognome
            authors.sort((a, b) => {
                const cognomeA = a.trim().split(' ').pop().toLowerCase();
                const cognomeB = b.trim().split(' ').pop().toLowerCase();
                return cognomeA.localeCompare(cognomeB, 'it');
            });

            let html = '';
            authors.forEach(author => {
                const count = authorCounts[author];
                let fontSize = minFont;
                if (maxCount > minCount) {
                    fontSize = minFont + ((count - minCount) / (maxCount - minCount)) * (maxFont - minFont);
                }
                
                // Separa nome e cognome per mettere il cognome in grassetto
                const parts = author.trim().split(' ');
                const cognome = parts.pop();
                const nome = parts.join(' ');
                const displayName = nome ? `${nome} <strong>${cognome}</strong>` : `<strong>${cognome}</strong>`;
                
                html += `<a href="#" onclick="filterByAuthor('${author.replace(/'/g, "\\'")}'); return false;" style="font-size: ${fontSize}em;">${displayName} (${count})</a>`;
            });

            cloudContainer.innerHTML = html;
            
            // Popola anche il select mobile
            const selectMobile = document.getElementById('author-select');
            if (selectMobile) {
                let optionsHtml = '<option value="">Tutti gli autori</option>';
                authors.forEach(author => {
                    const count = authorCounts[author];
                    optionsHtml += `<option value="${author}">${author} (${count})</option>`;
                });
                selectMobile.innerHTML = optionsHtml;
                
                // Event listener per il select
                selectMobile.addEventListener('change', function() {
                    const selectedAuthor = this.value;
                    if (selectedAuthor) {
                        filterByAuthor(selectedAuthor);
                    } else {
                        showAll();
                    }
                });
            }
        }

        // Filtra schede per autore (scroll alla prima scheda)
        function filterByAuthor(author) {
            const cards = document.querySelectorAll('.scheda-card');
            let firstMatch = null;
            
            cards.forEach(card => {
                const cardAuthor = card.querySelector('.post-author').textContent;
                if (cardAuthor === author) {
                    card.style.display = 'block';
                    if (!firstMatch) firstMatch = card;
                } else {
                    card.style.display = 'none';
                }
            });
            
            if (firstMatch) {
                firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Aggiorna contatore
            const visible = Array.from(cards).filter(c => c.style.display !== 'none').length;
            document.getElementById('total-count').innerHTML = 
                `${visible} ${visible === 1 ? 'scheda' : 'schede'} di ${author} <a href="#" onclick="showAll(); return false;" style="color:#5a3f11; margin-left:10px;">Mostra tutte</a>`;
        }

        // Mostra tutte le schede
        function showAll() {
            const cards = document.querySelectorAll('.scheda-card');
            cards.forEach(card => card.style.display = 'block');
            
            document.getElementById('total-count').textContent = 
                `${cards.length} ${cards.length === 1 ? 'scheda' : 'schede'} pubblicate`;
        }

        // Carica e visualizza l'archivio completo
        async function loadArchive() {
            try {
                const response = await fetch('../data/tribuna.json');
                const posts = await response.json();

                // Ordina per data decrescente
                posts.sort((a, b) => parseItalianDate(b.date) - parseItalianDate(a.date));

                // Aggiorna contatore
                document.getElementById('total-count').textContent = 
                    `${posts.length} ${posts.length === 1 ? 'scheda' : 'schede'} pubblicate`;

                // Genera griglia
                const container = document.getElementById('archive-content');
                let html = '';

                posts.forEach(post => {
                    const slug = makeSlug(post.date);
                    const filename = `${slug}.html`;
                    
                    html += `
                        <div class="scheda-card">
                            <div class="post-date">${post.date}</div>
                            <div class="post-author">${post.author}</div>
                            <div class="post-title">${post.title}</div>
                            <a href="${filename}" class="post-link">Leggi scheda →</a>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // Genera cloud autori
                generateAuthorsCloud(posts);

            } catch (error) {
                document.getElementById('archive-content').innerHTML = 
                    '<div class="scheda-card" style="color:#999; font-style:italic;">Errore nel caricamento dell\'archivio.</div>';
                console.error('Errore:', error);
            }
        }

        window.onload = loadArchive;
    </script>
</body>
</html>
